// 手機端（相機端）的修改 - 在startBroadcastBtn事件監聽器中

peer.on('call', (call) => {
    logDebug('收到來電請求，開始視頻流傳輸');
    if (!stream || !stream.getVideoTracks().length) {
        logDebug('錯誤：無可用視頻流');
        return;
    }
    
    // 重要修改：先檢查視頻軌道是否活躍
    const videoTrack = stream.getVideoTracks()[0];
    if (!videoTrack || videoTrack.readyState !== 'live') {
        logDebug(`警告：視頻軌道狀態異常: ${videoTrack ? videoTrack.readyState : '無軌道'}`);
        try {
            // 嘗試重新獲取相機流
            startCameraBtn.click();
            setTimeout(() => {
                // 使用新獲取的流回答通話
                call.answer(stream);
                logDebug('已使用重新獲取的流回答通話');
            }, 1000);
            return;
        } catch (err) {
            logDebug(`重新獲取視頻流失敗: ${err}`);
        }
    }
    
    // 先監控流統計數據，確保可以傳輸
    setInterval(() => {
        if (call.peerConnection) {
            call.peerConnection.getStats(null).then(stats => {
                let videoSent = false;
                stats.forEach(report => {
                    if (report.type === 'outbound-rtp' && report.kind === 'video') {
                        videoSent = true;
                        logDebug(`已發送 ${report.bytesSent} 字節視頻數據`);
                    }
                });
                if (!videoSent) {
                    logDebug('警告：未檢測到視頻數據傳輸');
                }
            });
        }
    }, 5000); // 每5秒檢查一次
    
    // 回答通話，傳送視頻流
    call.answer(stream);
    logDebug(`已回答通話請求，視頻軌道狀態: ${videoTrack.readyState}`);
    updateConnectionStatus('connected', '已連接 (傳輸中)');
    
    // 更詳細的ICE監控
    call.peerConnection.oniceconnectionstatechange = () => {
        const state = call.peerConnection.iceConnectionState;
        logDebug(`ICE狀態變更: ${state}`);
        if (state === 'failed' || state === 'disconnected') {
            updateConnectionStatus('disconnected', 'ICE連接失敗');
        }
    };
    
    // 添加傳輸狀態監控
    call.peerConnection.onconnectionstatechange = () => {
        logDebug(`連接狀態變更: ${call.peerConnection.connectionState}`);
    };
    
    call.on('error', (err) => {
        logDebug(`通話錯誤: ${err}`);
        updateConnectionStatus('disconnected', '連接錯誤');
    });
    
    call.on('close', () => {
        logDebug('通話已結束');
        updateConnectionStatus('connected', '已連接 (等待接收端)');
    });
});

// 電腦端（接收端）的修改 - 在joinRoomBtn點擊事件內

peer.on('open', (id) => {
    logDebug(`已連接到PeerJS服務器，本機ID: ${id}`);
    
    // 不使用空流，直接使用null來發起呼叫
    currentCall = peer.call(roomId, null);
    logDebug('已發起呼叫請求');
    
    const timeout = setTimeout(() => {
        if (!remoteVideo.srcObject) {
            logDebug('連接超時，嘗試重新呼叫');
            if (currentCall) currentCall.close();
            
            // 重要修改：使用null代替空的MediaStream
            currentCall = peer.call(roomId, null);
            setupCallListeners();
            
            // 添加第二次超時處理
            setTimeout(() => {
                if (!remoteVideo.srcObject) {
                    logDebug('第二次嘗試仍未收到視頻流，請檢查手機端是否正確開啟相機和廣播');
                    errorMsg.textContent = '連接失敗，請確認以下事項：1.手機已點擊"開始廣播" 2.房間ID正確 3.相機權限已允許';
                }
            }, 10000);
        }
    }, 10000);
    
    function setupCallListeners() {
        currentCall.on('stream', (remoteStream) => {
            clearTimeout(timeout);
            logDebug(`收到遠端流: 視頻軌道數=${remoteStream.getVideoTracks().length}, 音頻軌道數=${remoteStream.getAudioTracks().length}`);
            
            if (remoteStream.getVideoTracks().length) {
                const videoTrack = remoteStream.getVideoTracks()[0];
                logDebug(`視頻軌道狀態: ${videoTrack.readyState}, 已啟用: ${videoTrack.enabled}`);
                
                remoteVideo.srcObject = remoteStream;
                updateConnectionStatus('connected', '已連接 (接收中)');
                updateButtonStates();
                
                // 監控接收的視頻數據
                setInterval(() => {
                    if (currentCall && currentCall.peerConnection) {
                        currentCall.peerConnection.getStats(null).then(stats => {
                            let videoReceived = false;
                            stats.forEach(report => {
                                if (report.type === 'inbound-rtp' && report.kind === 'video') {
                                    videoReceived = true;
                                    logDebug(`已接收 ${report.bytesReceived} 字節視頻數據`);
                                }
                            });
                            if (!videoReceived) {
                                logDebug('警告：未檢測到視頻數據接收');
                            }
                        });
                    }
                }, 5000); // 每5秒檢查一次
            } else {
                logDebug('警告：收到的流沒有視頻軌道');
                errorMsg.textContent = '視頻流無效，請檢查手機相機是否正常工作';
            }
        });
        
        // 重要修正：監聽流添加事件
        currentCall.peerConnection.ontrack = (event) => {
            logDebug(`檢測到新軌道添加: ${event.track.kind}, ID=${event.track.id}`);
            
            // 某些情況下，stream事件可能未觸發，這裡添加額外處理
            if (!remoteVideo.srcObject && event.streams && event.streams[0]) {
                logDebug('通過ontrack事件接收到流');
                remoteVideo.srcObject = event.streams[0];
                clearTimeout(timeout);
                updateConnectionStatus('connected', '已連接 (通過ontrack)');
                updateButtonStates();
            }
        };
        
        currentCall.peerConnection.oniceconnectionstatechange = () => {
            const state = currentCall.peerConnection.iceConnectionState;
            logDebug(`ICE狀態變更: ${state}`);
            if (state === 'failed' || state === 'disconnected') {
                updateConnectionStatus('disconnected', 'ICE連接失敗');
                errorMsg.textContent = 'ICE連接失敗，請嘗試重新連接或檢查網絡';
            }
        };
        
        currentCall.peerConnection.onconnectionstatechange = () => {
            logDebug(`連接狀態變更: ${currentCall.peerConnection.connectionState}`);
        };
        
        currentCall.on('error', (err) => {
            logDebug(`通話錯誤: ${err}`);
            errorMsg.textContent = `通話錯誤: ${err}`;
            updateConnectionStatus('disconnected', '連接錯誤');
        });
        
        currentCall.on('close', () => {
            logDebug('通話已關閉');
            remoteVideo.srcObject = null;
            updateConnectionStatus('disconnected', '連接已關閉');
            updateButtonStates();
        });
    }
    
    setupCallListeners();
});
